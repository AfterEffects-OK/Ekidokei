<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚ªãƒ³é¢¨ é§…æ™‚è¨ˆ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSSã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å®šç¾© */
        :root {
            --neon-color: #c7ff44; /* ãƒã‚ªãƒ³ã‚«ãƒ©ãƒ¼ã‚’ #c7ff44 ã«æ›´æ–° */
            --dark-background: #111111; /* ä¸€ç•ªå¤–å´ã®èƒŒæ™¯è‰²ã‚’æ¿ƒã„é»’ã«å¤‰æ›´ */
            --safe-size: 96vmin; /* JSãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã¾ã§ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚µã‚¤ã‚º */
        }
        
        /* å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        body { 
            font-family: 'Inter', sans-serif; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* ä¸­å¤®å¯„ã› */
            padding: 0; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å‰Šé™¤ã—ã¦æœ€å¤§åŒ– */
            background-color: var(--dark-background); 
            position: relative; /* ã‚°ãƒªãƒƒãƒ‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®åŸºæº–ç‚¹ */
            color: white;
            transition: background-color 0.5s;
            overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢ */
        }

        /* --- iOSæ“¬ä¼¼ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ç”¨ã‚¹ã‚¿ã‚¤ãƒ« (ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼éè¡¨ç¤ºã¯ä¸å¯) --- */
        .ios-fullscreen-active {
            margin: 0 !important;
            padding: 0 !important;
            width: 100vw;
            height: 100vh;
        }
        /* iOSæ“¬ä¼¼ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³æ™‚ã®æ™‚è¨ˆã‚³ãƒ³ãƒ†ãƒŠã®ã‚µã‚¤ã‚ºèª¿æ•´ã¯JSã§è¡Œã†ãŸã‚ã€CSSã¯ã»ã¼ä¸è¦ */
        /* -------------------------------------- */

        /* --- ã‚°ãƒªãƒƒãƒ‰/ã‚¹ã‚­ãƒ£ãƒ³ãƒ©ã‚¤ãƒ³ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ --- */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            /* subtle grid pattern */
            background: 
                repeating-linear-gradient(to right, rgba(0,0,0,.15), rgba(0,0,0,.15) 1px, transparent 1px, transparent 40px),
                repeating-linear-gradient(to bottom, rgba(0,0,0,.15), rgba(0,0,0,.15) 1px, transparent 1px, transparent 40px);
            z-index: -1;
            opacity: 0.5;
            transition: opacity 0.5s;
        }
        .no-grid::before {
            opacity: 0;
        }
        /* -------------------------------------- */
        
        /* ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .neon-button {
            background-color: var(--dark-background); 
            color: white;
            transition: transform 0.3s, background-color 0.3s, box-shadow 0.3s;
            z-index: 30;
        }
        .neon-button:hover {
            transform: scale(1.05);
        }
        .is-fullscreen {
            background-color: #222222; 
            box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.5) inset;
            transform: scale(1.02);
        }
        .is-fullscreen:hover {
            transform: scale(1.08);
        }


        /* æ™‚è¨ˆã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ« - ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã®ä¸­æ ¸ */
        #clockContainer {
            /* å¤‰æ›´: JSã§è¨ˆç®—ã—ã€çŸ­ã„è¾ºã«å¸¸ã«åã¾ã‚‹å®‰å…¨ãªã‚µã‚¤ã‚ºã‚’ä½¿ç”¨ */
            width: var(--safe-size);      
            height: var(--safe-size); /* æ­£æ–¹å½¢ã‚’ç¶­æŒ */
            
            max-width: 100%;    
            max-height: 100%; 
            aspect-ratio: 1 / 1; 
            background-color: transparent; 
            border-radius: 0; 
            box-shadow: none; 
            padding: 0;
            transition: transform 300ms;
            position: relative; 
        }

        /* Canvasã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #clockCanvas {
            border-radius: 0; 
            display: block; 
            width: 100%;
            height: 100%;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºã®ãŸã‚ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¯ãƒ©ã‚¹ */
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 300ms, transform 300ms;
        }
    </style>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let canvas, ctx, radius;
        let neonColorState; // ç¾åœ¨ã®ãƒã‚ªãƒ³è‰²ã‚’ä¿æŒã™ã‚‹çŠ¶æ…‹å¤‰æ•°
        
        // è¨­å®š
        const DIAL_COLOR = '#225822'; // æ–‡å­—ç›¤ã®å†…éƒ¨èƒŒæ™¯è‰²

        // æ–‡å­—ç›¤ç”»åƒã®è¨­å®š
        let faceImageUrl = 'https://raw.githubusercontent.com/AfterEffects-OK/Ekidokei/main/base.png'; 
        let faceImageObj = null;
        let isImageLoaded = false;

        /**
         * è§’åº¦ã‚’ãƒ©ã‚¸ã‚¢ãƒ³ã«å¤‰æ›ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
         */
        function toRadians(degrees) {
            return (Math.PI / 180) * degrees;
        }
        
        /**
         * CSSã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰ç¾åœ¨ã®ãƒã‚ªãƒ³è‰²ã‚’å–å¾—
         */
        function getNeonColor() {
            return getComputedStyle(document.documentElement).getPropertyValue('--neon-color').trim();
        }

        /**
         * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‹ã‚‰iOSãƒ‡ãƒã‚¤ã‚¹ã‚’åˆ¤å®š
         */
        function isIOS() {
            return [
                'iPad Simulator',
                'iPhone Simulator',
                'iPod Simulator',
                'iPad',
                'iPhone',
                'iPod'
            ].includes(navigator.platform)
            // iPadOS 13+ detection
            || (navigator.userAgent.includes("Mac") && "ontouchend" in document)
        }

        /**
         * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤ºã™ã‚‹
         */
        function showMessage(message, colorClass = 'bg-blue-500') {
            const box = document.getElementById('messageBox');
            box.className = `fixed bottom-4 right-4 text-white p-3 rounded-lg shadow-xl transition-opacity duration-300 z-50 ${colorClass}`;
            box.textContent = message;
            box.classList.remove('hidden', 'opacity-0');
            box.classList.add('opacity-100');

            setTimeout(() => {
                box.classList.remove('opacity-100');
                box.classList.add('opacity-0');
                setTimeout(() => box.classList.add('hidden'), 300);
            }, 5000); 
        }

        /**
         * ç”»åƒã‚’éåŒæœŸã§èª­ã¿è¾¼ã¿ã€Canvasã«é©ç”¨ã™ã‚‹
         */
        function loadImage(url) {
            isImageLoaded = false;
            faceImageObj = null;

            if (!url || url.trim() === '') {
                drawClock(); 
                return;
            }

            const img = new Image();
            img.crossOrigin = 'anonymous'; 
            
            const timeout = setTimeout(() => {
                img.onload = null; 
                img.onerror = null; 
                showMessage(`ç”»åƒãƒ­ãƒ¼ãƒ‰ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚`, 'bg-red-500');
                drawClock();
            }, 5000); 

            img.onload = () => {
                clearTimeout(timeout); 
                faceImageObj = img;
                isImageLoaded = true;
                showMessage('æ–°ã—ã„æ–‡å­—ç›¤ç”»åƒã‚’é©ç”¨ã—ã¾ã—ãŸã€‚', 'bg-green-500');
            };
            img.onerror = () => {
                clearTimeout(timeout); 
                showMessage(`ã‚«ã‚¹ã‚¿ãƒ ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚URLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`, 'bg-red-500');
            };
            img.src = url;
        }

        /**
         * UIã‹ã‚‰URLã‚’å–å¾—ã—ã€ç”»åƒãƒ­ãƒ¼ãƒ‰ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹
         */
        function applyImage() {
            faceImageUrl = document.getElementById('faceImageUrl').value;
            loadImage(faceImageUrl);
        }
        
        /**
         * ãƒã‚ªãƒ³ã‚«ãƒ©ãƒ¼ã®å¤‰æ›´ã‚’é©ç”¨ã™ã‚‹
         */
        function changeNeonColor(newColor) {
            document.documentElement.style.setProperty('--neon-color', newColor);
            neonColorState = newColor;
            
            document.getElementById('neonColorPreview').style.backgroundColor = newColor;
            
            showMessage(`ãƒã‚ªãƒ³ã‚«ãƒ©ãƒ¼ã‚’ ${newColor} ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚`, 'bg-indigo-500');
        }

        /**
         * ã‚°ãƒªãƒƒãƒ‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
         */
        function toggleGridEffect(isOn) {
            document.body.classList.toggle('no-grid', !isOn);
            showMessage(`èƒŒæ™¯ã‚°ãƒªãƒƒãƒ‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’${isOn ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}ã«ã—ã¾ã—ãŸã€‚`, 'bg-indigo-500');
        }

        /**
         * ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ
         */
        function toggleFullscreen() {
            if (isIOS()) {
                const isCurrentlyPseudoFullscreen = document.body.classList.contains('ios-fullscreen-active');
                
                document.body.classList.toggle('ios-fullscreen-active', !isCurrentlyPseudoFullscreen);
                handleFullscreenChange(); 
                resizeCanvas(); // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³çŠ¶æ…‹ãŒå¤‰ã‚ã£ãŸã‚‰å³åº§ã«ãƒªã‚µã‚¤ã‚ºã‚’å¼·åˆ¶å®Ÿè¡Œ

                const message = !isCurrentlyPseudoFullscreen 
                    ? 'ã€iOSã®åˆ¶é™ã€‘å®Œå…¨ã«ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã«ã™ã‚‹ã«ã¯ã€ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã—ã¦PWAã¨ã—ã¦èµ·å‹•ã—ã¦ãã ã•ã„ã€‚æ“¬ä¼¼ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã—ã¾ã—ãŸã€‚'
                    : 'æ“¬ä¼¼ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‚’ç„¡åŠ¹ã«ã—ã¾ã—ãŸã€‚';
                showMessage(message, !isCurrentlyPseudoFullscreen ? 'bg-yellow-600' : 'bg-indigo-500');
                return;
            }

            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    showMessage(`ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸ: ${err.message}`, 'bg-red-500');
                });
            } else {
                document.exitFullscreen();
            }
        }

        /**
         * ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³çŠ¶æ…‹ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã«ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°ã™ã‚‹
         */
        function handleFullscreenChange() {
            const btn = document.getElementById('fullscreenToggleBtn');
            const iconContainer = btn.querySelector('#fullscreenIcon');
            
            const isFullscreen = document.fullscreenElement || document.body.classList.contains('ios-fullscreen-active');

            btn.classList.toggle('is-fullscreen', isFullscreen); 
            
            iconContainer.innerHTML = ''; 

            if (isFullscreen) {
                // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ä¸­ã®ã‚¢ã‚¤ã‚³ãƒ³ (æœ€å°åŒ–/çµ‚äº†)
                iconContainer.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/>
                    </svg>
                `;
            } else {
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®ã‚¢ã‚¤ã‚³ãƒ³ (æœ€å¤§åŒ–/é–‹å§‹)
                iconContainer.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 8V4h4"/><path d="M20 8V4h-4"/><path d="M4 16v4h4"/><path d="M16 20h4v-4"/>
                    </svg>
                `;
            }
        }
        
        /**
         * è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
         */
        function openSettingsModal() {
            const modal = document.getElementById('settingsModal');
            const content = document.getElementById('settingsModalContent');
            
            modal.classList.remove('hidden');
            
            content.classList.remove('modal-enter');
            content.classList.add('modal-enter-active');
            
            document.getElementById('faceImageUrl').value = faceImageUrl;
        }

        /**
         * è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
         */
        function closeSettingsModal() {
            const modal = document.getElementById('settingsModal');
            const content = document.getElementById('settingsModalContent');

            content.classList.remove('modal-enter-active');
            content.classList.add('modal-enter');

            setTimeout(() => {
                 modal.classList.add('hidden');
            }, 300);
        }

        /**
         * æ™‚è¨ˆã®æç”»å‡¦ç†ã‚’ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆã«åˆã‚ã›ã¦å®Ÿè¡Œ
         */
        function drawClock() {
            ctx.clearRect(-radius, -radius, radius * 2, radius * 2); 
            
            drawFace(ctx, radius);
            
            const now = new Date();
            let h = now.getHours();
            const m = now.getMinutes();
            const s = now.getSeconds();
            
            const digitalText = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            
            const color = neonColorState;

            ctx.save();
            
            ctx.font = 'bold ' + radius * 0.12 + "px Inter, sans-serif";
            ctx.textBaseline = "middle";
            ctx.textAlign = "center";
            
            const yPosition = radius * 0.20; 
            const textMetrics = ctx.measureText(digitalText);
            const textWidth = textMetrics.width;
            const textHeight = radius * 0.12 * 1.2;
            
            // 1. é»’ã„èƒŒæ™¯ã‚’æç”»
            ctx.fillStyle = '#000000'; 
            ctx.shadowBlur = 0; 
            ctx.fillRect(
                -textWidth / 2 - radius * 0.02, 
                yPosition - textHeight / 2 - radius * 0.02,
                textWidth + radius * 0.04, 
                textHeight + radius * 0.04 
            );


            // 2. ãƒ†ã‚­ã‚¹ãƒˆï¼ˆãƒã‚ªãƒ³ã‚«ãƒ©ãƒ¼ï¼‰ã‚’æç”»
            ctx.fillStyle = color;
            ctx.shadowColor = color;
            ctx.shadowBlur = radius * 0.005; 
            
            ctx.fillText(digitalText, 0, yPosition);

            ctx.restore();
            
            drawTime(ctx, radius); 

            window.requestAnimationFrameId = requestAnimationFrame(drawClock);
        }

        /**
         * æ–‡å­—ç›¤ã¨ç›®ç››ã‚Šã€æ•°å­—ã‚’æç”»ã—ã¾ã™ (ãƒã‚ªãƒ³åŠ¹æœè¾¼ã¿)
         */
        function drawFace(ctx, radius) {
            const color = neonColorState;

            // 1. èƒŒæ™¯è‰²ã®æç”»ï¼ˆç”»åƒãŒãªã„å ´åˆï¼‰
            if (!isImageLoaded) {
                ctx.beginPath();
                ctx.arc(0, 0, radius * 0.95, 0, 2 * Math.PI);
                ctx.fillStyle = DIAL_COLOR;
                ctx.fill();
            }

            // 1b. ã‚«ã‚¹ã‚¿ãƒ ç”»åƒã®æç”» (æ­£æ–¹å½¢ã‚¯ãƒªãƒƒãƒ”ãƒ³ã‚°)
            if (faceImageObj && isImageLoaded) {
                const imgSize = radius * 2; 

                ctx.save();
                ctx.beginPath();
                ctx.rect(-radius, -radius, imgSize, imgSize); 
                ctx.clip(); 
                
                ctx.drawImage(faceImageObj, -radius, -radius, imgSize, imgSize);
                
                ctx.restore(); 
            }

            // 3. ç›®ç››ã‚Šã¨æ•°å­—ã‚’æç”» (ç”»åƒãŒé©ç”¨ã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿å®Ÿè¡Œ)
            if (!isImageLoaded) { 
                ctx.fillStyle = color; 
                ctx.strokeStyle = color; 
                
                ctx.shadowBlur = radius * 0.015;
                ctx.shadowColor = color;

                // ç›®ç››ã‚Šã‚’æç”»
                for (let i = 1; i <= 60; i++) {
                    ctx.beginPath();
                    const angle = toRadians(i * 6); 
                    const isHourMark = i % 5 === 0;

                    const markLength = isHourMark ? radius * 0.08 : radius * 0.03; 
                    const markWidth = isHourMark ? radius * 0.02 : radius * 0.008; 

                    const x1 = Math.sin(angle) * radius * 0.90; 
                    const y1 = -Math.cos(angle) * radius * 0.90; 
                    const x2 = Math.sin(angle) * (radius * 0.90 - markLength); 
                    const y2 = -Math.cos(angle) * (radius * 0.90 - markLength); 
                    
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.lineWidth = markWidth;
                    ctx.lineCap = 'round'; 
                    ctx.stroke();
                }

                // æ•°å­—ã‚’æç”»
                ctx.font = 'bold ' + radius * 0.15 + "px Arial, sans-serif";
                ctx.textBaseline = "middle";
                ctx.textAlign = "center";

                for(let num = 1; num <= 12; num++){
                    const angle = num * Math.PI / 6;
                    const x = radius * 0.75 * Math.sin(angle); 
                    const y = radius * 0.75 * -Math.cos(angle);
                    ctx.fillText(num.toString(), x, y);
                }
            }
        }


        /**
         * æ™‚é‡ã€åˆ†é‡ã€ç§’é‡ã‚’æç”»ã—ã¾ã™
         */
        function drawTime(ctx, radius) {
            const now = new Date();
            let hour = now.getHours();
            let minute = now.getMinutes();
            let second = now.getSeconds();
            let millisecond = now.getMilliseconds();
            const color = neonColorState;

            hour = hour % 12;
            let hourAngle = (hour * Math.PI / 6) + (minute * Math.PI / (6 * 60)) + (second * Math.PI / (360 * 60));
            let minuteAngle = (minute * Math.PI / 30) + (second * Math.PI / (30 * 60)) + (millisecond * Math.PI / (30 * 60 * 1000));
            let secondAngle = (second * Math.PI / 30); 

            ctx.shadowBlur = radius * 0.01;
            ctx.shadowColor = color;

            // ç§’é‡ã‚’æç”»
            drawHand(ctx, secondAngle, radius * 0.70, radius * 0.015, color, 'second'); 
            // åˆ†é‡ã‚’æç”»
            drawHand(ctx, minuteAngle, radius * 0.686, radius * 0.04, color, 'minute'); 
            // æ™‚é‡ã‚’æç”»
            drawHand(ctx, hourAngle, radius * 0.40, radius * 0.08, color, 'hour'); 

            // ä¸­å¤®ã®ãƒ”ãƒ³
            ctx.beginPath();
            ctx.arc(0, 0, radius * 0.04, 0, 2 * Math.PI);
            ctx.fillStyle = color;
            ctx.shadowBlur = radius * 0.025; 
            ctx.shadowColor = color;
            ctx.fill();

            // å…¨ã¦ã®ã‚°ãƒ­ãƒ¼åŠ¹æœã‚’ãƒªã‚»ãƒƒãƒˆ
            ctx.shadowBlur = 0;
            ctx.shadowColor = 'transparent';
        }

        /**
         * é‡ã®æç”»ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (å¤ªã„æœ¬ä½“ã¨å°–ã£ãŸå…ˆç«¯ã‚’æŒã¤å¤šè§’å½¢æç”»)
         */
        function drawHand(ctx, pos, length, baseWidth, color, type) {
            
            ctx.save();
            ctx.rotate(pos); 
            
            ctx.fillStyle = color;
            ctx.strokeStyle = color;
            ctx.lineWidth = radius * 0.005; 

            const tailLength = radius * (type === 'second' ? 0.2 : type === 'minute' ? 0.1 : 0.05);
            
            let tipBaseWidth = 0; 
            const tipLengthRatio = (type === 'minute') ? 0.98 : 0.96; 
            
            if (type === 'minute' || type === 'hour') {
                tipBaseWidth = baseWidth * 0.5; 
            }

            ctx.beginPath();
            
            // 1. æ ¹æœ¬ã®å·¦ä¸‹ (å°¾éƒ¨ã®ç«¯)
            ctx.moveTo(-baseWidth / 2, tailLength); 
            
            // 2. æ ¹æœ¬ã®å³ä¸‹ (å°¾éƒ¨ã®ç«¯)
            ctx.lineTo(baseWidth / 2, tailLength); 
            
            // 3. æ ¹å…ƒä¸Šéƒ¨ï¼ˆä¸­å¿ƒï¼‰ã®å³å´
            ctx.lineTo(baseWidth * 0.4, 0); 
            
            if (tipBaseWidth > 0) {
                const bodyLength = length * tipLengthRatio;
                
                // 4. å¤ªã„æœ¬ä½“ã®çµ‚ã‚ã‚Šï¼ˆå³å´ï¼‰
                ctx.lineTo(tipBaseWidth / 2, -bodyLength); 
                
                // 5. é ‚ç‚¹ (é‹­åˆ©ãªå…ˆç«¯)
                ctx.lineTo(0, -length); 
                
                // 6. å¤ªã„æœ¬ä½“ã®çµ‚ã‚ã‚Šï¼ˆå·¦å´ï¼‰
                ctx.lineTo(-tipBaseWidth / 2, -bodyLength);
                
                // 7. æ ¹å…ƒä¸Šéƒ¨ï¼ˆä¸­å¿ƒï¼‰ã®å·¦å´ã«æˆ»ã‚‹
                ctx.lineTo(-baseWidth * 0.4, 0); 
            } else {
                // ç§’é‡ã®å ´åˆ
                ctx.lineTo(0, -length); 
                ctx.lineTo(-baseWidth * 0.4, 0); 
            }

            ctx.closePath();
            
            ctx.fill(); 
            ctx.stroke(); 

            ctx.restore();
        }


        /**
         * Canvasã®ã‚µã‚¤ã‚ºã‚’è¦ªè¦ç´ ã«åˆã‚ã›ã¦è¨­å®šã—ã€å†æç”»ã™ã‚‹ (ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ)
         * ã“ã®é–¢æ•°ãŒiOSã®ç¸¦æ¨ªåˆ‡ã‚Šæ›¿ãˆã®ä¸å®‰å®šã•å¯¾ç­–ã®ä¸­æ ¸ã§ã™ã€‚
         */
        function resizeCanvas() {
            // 1. ç”»é¢ã®å¹…ã¨é«˜ã•ã‚’å–å¾—ã—ã€çŸ­ã„æ–¹ã‚’åŸºæº–ã«ã‚µã‚¤ã‚ºã‚’è¨ˆç®— (iOSå¯¾ç­–)
            // window.innerHeightã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã®æœ‰ç„¡ã«ã‚ˆã‚‹è¡¨ç¤ºé ˜åŸŸã®å¤‰åŒ–ã«å¯¾å¿œã—ã¾ã™ã€‚
            const minDimension = Math.min(window.innerWidth, window.innerHeight);
            
            // çŸ­ã„æ–¹ã®98%ã‚’å®‰å…¨ãªã‚µã‚¤ã‚ºã¨ã—ã¦è¨­å®š (2%ã®ãƒãƒ¼ã‚¸ãƒ³)
            const safeSize = minDimension * 0.98; 

            // CSSã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«è¨­å®šã—ã¦ã€#clockContainerã®ã‚µã‚¤ã‚ºã‚’å¼·åˆ¶çš„ã«åˆ¶å¾¡
            document.documentElement.style.setProperty('--safe-size', `${safeSize}px`);
            
            // 2. Canvasè‡ªèº«ã®ç‰©ç†çš„ãªãƒªã‚µã‚¤ã‚ºå‡¦ç†
            const container = canvas.parentNode;
            // containerã®offsetWidthã¯ã€ä¸Šè¨˜ã§è¨­å®šã—ãŸCSSã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚ˆã£ã¦å®šç¾©ã•ã‚Œã‚‹
            const size = container.offsetWidth; 
            const scale = window.devicePixelRatio || 1;
            
            // è«–ç†ã‚µã‚¤ã‚ºã‚’è¨­å®š
            canvas.style.width = size + 'px';
            canvas.style.height = size + 'px';
            
            // ç‰©ç†ãƒ”ã‚¯ã‚»ãƒ«ã‚µã‚¤ã‚ºã‚’è¨­å®š
            canvas.width = size * scale;
            canvas.height = size * scale;

            // æç”»ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
            ctx.scale(scale, scale);
            
            // æç”»ã®åŸç‚¹ã‚’ä¸­å¿ƒã«ç§»å‹•ã—ç›´ã™
            radius = size / 2;
            ctx.setTransform(scale, 0, 0, scale, 0, 0); // ã‚¹ã‚±ãƒ¼ãƒ«ã®ã¿é©ç”¨ã—ã€ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            ctx.translate(radius, radius); // åŸç‚¹ã‚’ä¸­å¤®ã«å†è¨­å®š
        }

        /**
         * åˆæœŸåŒ–å‡¦ç†
         */
        function initializeClock() {
            canvas = document.getElementById("clockCanvas");
            ctx = canvas.getContext("2d");
            
            // åˆæœŸãƒªã‚µã‚¤ã‚ºã¨æç”» (åŸç‚¹è¨­å®šã¨ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã‚’å«ã‚€)
            resizeCanvas();
            
            // åˆæœŸã‚«ãƒ©ãƒ¼è¨­å®š (CSSå¤‰æ•°ã‹ã‚‰å–å¾—)
            const initialColor = getNeonColor();
            neonColorState = initialColor;

            // UIã®åˆæœŸå€¤ã‚’è¨­å®š
            document.getElementById('faceImageUrl').value = faceImageUrl;
            document.getElementById('neonColorPicker').value = initialColor;
            document.getElementById('neonColorPreview').style.backgroundColor = initialColor;
            
            // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š ---
            document.getElementById('neonColorPicker').onchange = (e) => changeNeonColor(e.target.value);
            const toggleGridInput = document.getElementById('toggleGrid');
            toggleGridInput.onchange = (e) => toggleGridEffect(e.target.checked);
            
            // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒœã‚¿ãƒ³
            document.getElementById('fullscreenToggleBtn').onclick = toggleFullscreen;
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            handleFullscreenChange(); // åˆæœŸã‚¢ã‚¤ã‚³ãƒ³è¨­å®š
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('openSettingsBtn').onclick = openSettingsModal;
            document.getElementById('closeSettingsBtn').onclick = closeSettingsModal;
            document.getElementById('settingsModal').onclick = (e) => {
                if (e.target.id === 'settingsModal') {
                    closeSettingsModal();
                }
            };
            
            toggleGridEffect(document.getElementById('toggleGrid').checked); 
            
            // ç”»åƒã®è‡ªå‹•é©ç”¨
            loadImage(faceImageUrl);

            // ç”»é¢ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã®ãƒªã‚µã‚¤ã‚º (iOSã®ç¸¦æ¨ªåˆ‡ã‚Šæ›¿ãˆã«å¯¾å¿œ)
            window.addEventListener('resize', resizeCanvas);
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—é–‹å§‹
            drawClock(); 
        }

        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¦ã‹ã‚‰åˆæœŸåŒ–é–¢æ•°ã‚’å‘¼ã³å‡ºã™
        window.onload = initializeClock;

    </script>
</head>
<body class="font-sans">

    <!-- æ™‚è¨ˆã‚³ãƒ³ãƒ†ãƒŠ (ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãªã‚µã‚¤ã‚ºè¨­å®š) -->
    <div id="clockContainer" class="flex items-center justify-center">
        <canvas id="clockCanvas"></canvas>
        
        <!-- ğŸ–¥ï¸ ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ (Absolute - æ™‚è¨ˆã‚³ãƒ³ãƒ†ãƒŠå†…ã€å·¦ä¸Šéš…) -->
        <button id="fullscreenToggleBtn" class="neon-button absolute top-2 left-2 p-2 rounded-full transition duration-300">
            <span id="fullscreenIcon">
                <!-- åˆæœŸã‚¢ã‚¤ã‚³ãƒ³: h-5 w-5 -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 8V4h4"/><path d="M20 8V4h-4"/><path d="M4 16v4h4"/><path d="M16 20h4v-4"/>
                </svg>
            </span>
        </button>

        <!-- âš™ï¸ è¨­å®šã‚¢ã‚¤ã‚³ãƒ³ãƒœã‚¿ãƒ³ (Absolute - æ™‚è¨ˆã‚³ãƒ³ãƒ†ãƒŠå†…ã€å³ä¸Šéš…) -->
        <button id="openSettingsBtn" class="neon-button absolute top-2 right-2 p-2 rounded-full transition duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37h.001z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>
    </div>
    
    <!-- è¨­å®šãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—/ãƒ¢ãƒ¼ãƒ€ãƒ« (åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤º) -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-70 z-40 hidden flex items-center justify-center p-4">
        <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div id="settingsModalContent" class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg space-y-4 relative p-6 modal-enter">
            <!-- é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ -->
            <button id="closeSettingsBtn" class="absolute top-3 right-3 text-gray-400 hover:text-[var(--neon-color)] transition duration-150 p-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            
            <h2 class="text-2xl font-extrabold text-white border-b border-gray-600 pb-3">æ™‚è¨ˆè¨­å®š</h2>

            <!-- ãƒã‚ªãƒ³ã‚«ãƒ©ãƒ¼è¨­å®š -->
            <div>
                <label for="neonColorPicker" class="block text-sm font-bold text-gray-200 mb-2 flex items-center">
                    ãƒã‚ªãƒ³ã‚«ãƒ©ãƒ¼ã‚’é¸æŠ: 
                    <span id="neonColorPreview" class="ml-2 w-5 h-5 rounded-full inline-block border-2 border-white/50"></span>
                </label>
                <input type="color" id="neonColorPicker" class="w-full h-10 p-1 border-gray-500 rounded-md bg-gray-900 cursor-pointer" />
            </div>

            <!-- ã‚°ãƒªãƒƒãƒ‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãƒˆã‚°ãƒ« -->
            <div class="flex items-center justify-between pt-2">
                <label for="toggleGrid" class="text-sm font-bold text-gray-200">èƒŒæ™¯ã‚°ãƒªãƒƒãƒ‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ</label>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="toggleGrid" class="sr-only peer"> 
                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 dark:peer-focus:ring-indigo-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-[var(--neon-color)]"></div>
                </label>
            </div>

            <!-- ã‚«ã‚¹ã‚¿ãƒ ç”»åƒè¨­å®š -->
            <div class="pt-4 border-t border-gray-600">
                <label for="faceImageUrl" class="block text-sm font-bold text-gray-200 mb-2">ã‚«ã‚¹ã‚¿ãƒ æ–‡å­—ç›¤ç”»åƒURL</label>
                <input type="url" id="faceImageUrl" placeholder="ç”»åƒã‚’é©ç”¨ã—ãŸã„URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" class="w-full p-2 border border-gray-500 rounded-md bg-gray-900 text-gray-100 placeholder-gray-400 focus:ring-2 focus:ring-[var(--neon-color)] focus:border-[var(--neon-color)]" />
                <button onclick="applyImage(); closeSettingsModal();" class="mt-3 w-full bg-[var(--neon-color)] text-gray-900 py-2 rounded-md font-bold hover:opacity-90 transition duration-150 shadow-md shadow-[var(--neon-color)]/50">
                    ç”»åƒã‚’é©ç”¨ / æ›´æ–°
                </button>
                <p class="text-xs text-gray-400 mt-2">â€» å¤–éƒ¨URLã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€CORSãƒãƒªã‚·ãƒ¼ã«ã‚ˆã‚Šè¡¨ç¤ºã§ããªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</p>
            </div>
        </div>
    </div>
    
    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ -->
    <div id="messageBox" class="fixed bottom-4 right-4 text-white p-3 rounded-lg shadow-xl hidden opacity-0 z-50"></div>
    
</body>
</html>
